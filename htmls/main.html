<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/vnd.microsoft.icon">
    <title>HAL MS PROJECT</title>
    <link rel="stylesheet" href="../css/main.css">
    <script src="../js/chart.min.js"></script>
    <script type="text/javascript" src="../js/jquery-2.0.3.min.js"></script>
    <script src="../js/particles.js-master/particles.js"></script>
    <script src="../js/audioManager.min.js"></script>
    <script src="../js/getQuery.js"></script>
    <script src="../js/audio.js"></script>
    <script src="../js/numCheck.js"></script>
    <style type="text/css">
    @-webkit-keyframes fadein {
      0%{
        opacity:0;
      }
      75%{
        opacity:0.5;
      }
      100% {
        opacity:1;
      }
    }

    #graph-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      max-width: 80%;
      max-height: 80%;
      margin: auto;
      background-color: white;
      z-index: 10;
      -webkit-animation: fadein 1.5s linear 0s 1;
    }
    #graph {
      max-width: 60%;
      float: left;
    }
    #graph-container div {
      max-width: 60%;
      float: left;
    }

    canvas#visualizer {
      position: absolute;
      background: rgba(0,0,0,0);
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
    }

    </style>
  </head>
  <body>

    <div id="back"></div>

    <!-- audio sun -->
    <canvas id="visualizer"></canvas>

    <!-- shooting star -->
    <div id="particles-js"></div>


    <!-- planetarium star's -->
    <div id="particles-star"></div>

    <!-- milky way -->
    <div id="milkyway"></div>

    <div id="graph-container">
      <canvas id="graph"></canvas>
      <div>
        <h1>解説</h1>
        <p>解説テキスト</p>
      </div>
    </div>

    <script src="../js/set.js"></script>
    <script src="../js/anim.js"></script>
    <script src="../js/star.js"></script>
    <script type="text/javascript">

      let disp = document.getElementById("graph-container").style.display = "none";
      window.addEventListener("keydown", handleKeydown);
      function handleKeydown(event){
        if (event["key"] == "Enter") {
          if (disp == "block") {
            document.getElementById("graph-container").style.display = "none";
            document.location.href = "./title.html";
          } else {
            disp = document.getElementById("graph-container").style.display = "block";
            displayGraph(value);
          }
        }
      }

      function getQuery() {
        if (1 < document.location.search.length) {
          var query = document.location.search.substring(1);
          var parameters = query.split('&');
          var result = new Object();
            for (var i = 0; i < parameters.length; i++) {
              var element = parameters[i].split('=');
              var paramName = decodeURIComponent(element[0]);
              var paramValue = decodeURIComponent(element[1]);
              result[paramName] = decodeURIComponent(paramValue);
            }
          return result;
        }
      }

      function someFunc(value) {
        const colorList = [
          ["#ff0000","#ffbbbb","#ffbb00","#ff00bb"], // red
          ["#00ff00","#bbff00","#bbffbb","#00ffbb"], // orange
          ["#0000ff","#bb00ff","#00bbff","#bbbbff"], // yellow
          ["#0000ff","#bb00ff","#00bbff","#bbbbff"], // green
          ["#0000ff","#bb00ff","#00bbff","#bbbbff"], // blue
          ["#ff00ff","#ff00ff","#ff00ff","#ff00ff"]  // purple
        ];

        const stars = {
          "value"   : value[0],
          "size"    : value[1],
          "opacity" : value[2],
          "color"   : colorList[value[3]],
        }

        const shootings = {
          "speed"   : value[4],
          "size"    : value[5],
          "opacity" : value[6],
          "color"   : value[7],
        }

        const milkys = {
          "value"   : value[8],
          "color"   : colorList[value[9]],
          "size"    : value[10],
          "opacity" : value[11],
          "left"    : value[12],
          "rotate"  : value[13],
        }
        
        star(stars);
        milky(milkys);
        shooting(shootings);
      }

      const current_path = location.href;
      const index = current_path.indexOf("htmls");
      const path = current_path.substring(0, index);
      const url = path + "json/sample.json";
      // const getData = getQuery();
      // const url = path + "json/" + getData["name"] + ".json";

      function displayGraph(value) {
        var ctx = document.getElementById('graph').getContext('2d');
        ctx.canvas.height =  window.innerHeight/3;
        var myChart = new Chart(ctx, {
          type: 'polarArea',
          data: {
            labels: ["RED", "ORANGE", "YELLOW", "GREEN", "BLUE", "PURPLE"],
            datasets: [{
              backgroundColor: [
                "red",
                "orange",
                "yellow",
                "green",
                "blue",
                "purple"
              ],
              borderWidth: 5,
              data:[ value[6], value[1], value[2], value[3], value[4], value[5]]
            }]
          }
        });
      }

      let value;
      Promise.all([
        new Promise(resolve => window.addEventListener("load", () => resolve())),
        fetch(url)])
      .then(it => {
        return it[1].json()
      })
      .then(it => {
        const json = it;
        value = createNumber(json);
        someFunc(value);
        visualizer_design(it["visualizer-size"],it["visualizer-line_width"],it["visualizer-stroke"],it["visualizer-fill"])();
        return value
      })
      
//      $.when(
//        $.getJSON(url, function(jsonData) {
//          const value = createNumber(jsonData);
//          test = createNumber(jsonData);
//        }), window.onload = visualizer_design(100,1.0,'#0f0','rgb(0, 255, 0)')
//      ).done(function(){
//        console.log("done")
//        console.log(aa);
//        someFunc(test);
//
//      },
//      ).fail(function(){
//        console.log("error");
//      });
      
    </script>
  </body>
</html>